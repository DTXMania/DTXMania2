# ランクエフェクトを作る

* ランクとは、結果画面で成績として表示される文字のこと。SS, S, A, B, C, D, E の7種類がある。
* ランクを表示するアニメーションを**ランクエフェクト**と称し、エフェクト作成ツール **[Effekseer](https://effekseer.github.io/jp/)** を使って作成する。
* Effekseer で作成したランクエフェクトファイルは、Effekseer（と EffekseerRendererDX11）の .NET Core ラッパーライブラリである
**Effekseer.NET** を使って、DTXMania2 に読み込まれ、再生・描画される。


## 作成手順

1. ランクエフェクトに使用するランク画像として、以下のものをそれぞれ準備する。  
   これらはすべて**128×128ピクセルの透過PNG**である。
    * RankSS.png
    * RankS.png
    * RankA.png
    * RankB.png
    * RankC.png
    * RankD.png
    * RankE.png  
1. Effekseer を起動し、好みのエフェクトを作成する。
1. エフェクトに、ランク画像を追加する。
    1. 新しいノードを追加する。このノードは、既定のスプライト（ビルボード）として原点上に配置される。
    1. [描画共通] ウィンドウで [読込] ボタンを押下し、ランク画像ファイルを読み込む。
    1. [拡大] ウィンドウで、画像の拡大率を **X:3.000, Y:3.000, Z:1.000** に変更する。（このサイズをランクエフェクトの基準とする。）
    1. [共通] ウィンドウで、**[寿命により削除] のチェックを外す**。（エフェクトの再生が終わってもランク画像を表示し続ける必要があるため。）
1. ランク画像のノードにあわせて、エフェクトの他のノードのサイズや位置を修正する。
    * 各ノードの**テクスチャのパスの修正**を忘れないこと。
1. 完成したランクエフェクトを、`.efkefc` または `.efk` 形式でファイルに保存する。
    * DTXMania2 プロジェクトに配置する際には、テクスチャファイルの同梱も忘れないこと。

## ランクエフェクトの表示

DTXMania2 では、他の 2D 画像と見た目をあわせ、左右上下移動に伴う歪みを削減するために、
Effekseer での射影行列の**視野角を狭く設定（10度）** している。
また、カメラは**Z軸上**(0,0,+z)にあり、その注視点は**原点**(0,0,0)である。
視野角、カメラ、注視点は常に固定である。

視野角が小さいため、エフェクトは、画面のどこに配置されても立体的な角度が付きにくい。
そのため、エフェクトに（ビルボードではなく）大きく角度を付けたい場合には、
該当するノードにX軸回転などを適用して適宜調整すること。



## その他の注意

`EffekseerNET.dll` は C++/CLI for .NET Core  で実装されたライブラリであり、このライブラリを実行するには
ライブラリと同じ場所に `Ijwhost.dll` というファイルを配置しておかなければならない。
（このファイルは、C++/CLI ライブラリのビルド時に一緒に出力される。）

`EffekseerNET.dll` は DTXMania2 プロジェクトに参照を追加するだけで使用できるが、`Ijwhost.dll` 
はネイティブライブラリであるためプロジェクトから参照することができない。
そのため、DTXMania2 プロジェクトに **`Ijwhost.dll` を追加**し、そのプロパティの [出力ディレクトリにコピー] 値を
「**新しい場合はコピーする**」に設定することで対応している。

